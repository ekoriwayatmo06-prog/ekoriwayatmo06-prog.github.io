<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Presensi Siswa Geotagging</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            touch-action: manipulation;
        }
        .video-container {
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            background: #000;
            aspect-ratio: 4/3;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        #photo-preview {
            display: none;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1rem;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-2xl flex flex-col items-center gap-3 text-center">
            <div class="loading-spinner"></div>
            <p class="text-sm font-semibold text-gray-700">Sedang Memproses...</p>
        </div>
    </div>

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col">
        <header class="bg-blue-600 p-6 text-white rounded-b-3xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold flex items-center gap-2">
                    <i data-lucide="user-check"></i> Presensi SMPN 2 Ceper
                </h1>
                <span id="current-time" class="text-sm font-mono font-medium opacity-90 bg-blue-700 px-3 py-1 rounded-full">00:00:00</span>
            </div>
            <div class="bg-blue-500 bg-opacity-30 p-4 rounded-xl backdrop-blur-sm border border-blue-400 space-y-3">
                <div>
                    <label class="text-[10px] uppercase tracking-wider opacity-80 font-bold mb-1 block">Nama Lengkap:</label>
                    <input type="text" id="student-name-input" class="w-full bg-white text-gray-800 font-semibold px-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 transition shadow-inner" placeholder="Masukkan Nama...">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] uppercase tracking-wider opacity-80 font-bold mb-1 block">Kelas:</label>
                        <input type="text" id="student-class-input" class="w-full bg-white text-gray-800 font-semibold px-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 transition shadow-inner" placeholder="Contoh: 7A">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase tracking-wider opacity-80 font-bold mb-1 block">No. Absen:</label>
                        <input type="number" id="student-no-input" class="w-full bg-white text-gray-800 font-semibold px-3 py-2 rounded-lg outline-none focus:ring-2 focus:ring-yellow-400 transition shadow-inner" placeholder="00">
                    </div>
                </div>
            </div>
        </header>

        <main class="p-6 flex-grow">
            <!-- Kamera -->
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-3 flex items-center gap-2">
                    <i data-lucide="camera" class="w-4 h-4 text-blue-600"></i> Ambil Foto Selfie (Verifikasi)
                </label>
                <div class="video-container shadow-inner border-2 border-gray-100 p-1 relative bg-gray-200">
                    <div id="camera-loading" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-100 text-gray-500 z-10 p-4 text-center">
                        <div id="camera-spinner" class="loading-spinner mb-3"></div>
                        <p id="loading-text" class="text-xs mb-4 text-gray-600">Mengakses perangkat kamera...</p>
                        <button id="btn-force-camera" class="hidden bg-blue-600 text-white text-xs font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <i data-lucide="video"></i> AKTIFKAN KAMERA
                        </button>
                    </div>
                    <video id="camera-stream" autoplay playsinline muted></video>
                    <canvas id="canvas" class="hidden"></canvas>
                    <img id="photo-preview" src="" alt="Preview">
                </div>
                <div class="mt-4 flex gap-3">
                    <button id="btn-capture" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-blue-700 transition active:scale-95">
                        <i data-lucide="aperture" class="w-5 h-5"></i> Ambil Foto
                    </button>
                    <button id="btn-retake" class="hidden flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-gray-300 transition active:scale-95">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i> Foto Ulang
                    </button>
                </div>
            </div>

            <!-- Geotagging -->
            <div id="geo-card" class="bg-blue-50 border border-blue-100 rounded-2xl p-4 mb-6 transition-colors">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-[10px] font-bold text-blue-800 flex items-center gap-2 tracking-widest uppercase">
                        <i data-lucide="map-pin" class="w-4 h-4"></i> Status Lokasi
                    </span>
                    <button id="btn-refresh-location" class="bg-white p-1.5 rounded-lg shadow-sm hover:shadow-md active:bg-blue-100 transition">
                        <i data-lucide="refresh-ccw" class="w-4 h-4 text-blue-600"></i>
                    </button>
                </div>
                
                <div id="location-status" class="text-sm text-gray-600 font-medium flex items-center gap-2">
                    <span id="gps-dot" class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></span> <span id="gps-text">Mencoba Mengakses GPS...</span>
                </div>

                <div id="gps-error-guide" class="hidden mt-3 text-[11px] bg-red-100 text-red-700 p-3 rounded-lg border border-red-200">
                    <p class="font-bold mb-1 tracking-tight">Izin Lokasi Diblokir atau GPS Mati</p>
                    <p class="mb-2 text-[10px]">Silakan aktifkan GPS dan izinkan akses lokasi di pengaturan browser Anda.</p>
                    <button id="btn-request-permission" class="w-full bg-red-600 text-white font-bold py-2 rounded-lg text-[10px] uppercase">COBA LAGI</button>
                </div>

                <div id="location-details" class="hidden mt-2 grid grid-cols-2 gap-2 p-2 bg-white rounded-lg border border-blue-100">
                    <div>
                        <p class="text-[9px] text-gray-400 uppercase">Lat</p>
                        <p class="text-[11px] font-mono font-bold text-gray-700" id="lat-val">-</p>
                    </div>
                    <div>
                        <p class="text-[9px] text-gray-400 uppercase">Long</p>
                        <p class="text-[11px] font-mono font-bold text-gray-700" id="long-val">-</p>
                    </div>
                </div>
            </div>

            <button id="btn-submit" disabled class="w-full bg-green-600 disabled:bg-gray-300 text-white font-bold py-4 rounded-2xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-3">
                <i data-lucide="send" class="w-5 h-5"></i> KIRIM PRESENSI
            </button>
        </main>
    </div>

    <!-- Modal Sukses -->
    <div id="modal-success" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-6 z-50">
        <div class="bg-white rounded-3xl p-8 w-full max-w-xs text-center shadow-2xl">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="check" class="w-12 h-12"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-1">Berhasil!</h3>
            <p class="text-gray-500 text-sm mb-6">Data sudah masuk ke daftar hadir.</p>
            <button onclick="closeModal('modal-success')" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Selesai</button>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzXyR3B-1tuF0G4srw7QFyZkXpj6Ig1sqtZOyFseDiHZKvvadgmKAcPXjgg5HAJxFOK8w/exec";

        let stream = null;
        let capturedImage = null;
        let userLocation = null;
        let watchId = null;

        const video = document.getElementById('camera-stream');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('photo-preview');
        const cameraLoading = document.getElementById('camera-loading');
        const cameraSpinner = document.getElementById('camera-spinner');
        const loadingText = document.getElementById('loading-text');
        const btnForceCamera = document.getElementById('btn-force-camera');
        
        const btnCapture = document.getElementById('btn-capture');
        const btnRetake = document.getElementById('btn-retake');
        const btnSubmit = document.getElementById('btn-submit');
        const locationStatus = document.getElementById('location-status');
        const locationDetails = document.getElementById('location-details');
        const gpsDot = document.getElementById('gps-dot');
        const gpsText = document.getElementById('gps-text');
        const latVal = document.getElementById('lat-val');
        const longVal = document.getElementById('long-val');
        const loadingOverlay = document.getElementById('loading-overlay');
        const studentNameInput = document.getElementById('student-name-input');
        const studentClassInput = document.getElementById('student-class-input');
        const studentNoInput = document.getElementById('student-no-input');

        window.addEventListener('load', () => {
            lucide.createIcons();
            setInterval(() => {
                const now = new Date();
                document.getElementById('current-time').innerText = now.toLocaleTimeString('id-ID', { hour12: false });
            }, 1000);
            
            // Beri jeda sedikit untuk memastikan DOM siap
            setTimeout(() => {
                initCamera();
                getLocation();
            }, 500);
        });

        async function initCamera() {
            cameraLoading.classList.remove('hidden');
            cameraSpinner.classList.remove('hidden');
            btnForceCamera.classList.add('hidden');
            loadingText.innerText = "Mengakses perangkat kamera...";

            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                const constraints = { 
                    video: { 
                        facingMode: "user",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }, 
                    audio: false 
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    video.play().catch(e => console.error("Video play failed:", e));
                    cameraLoading.classList.add('hidden');
                };
            } catch (err) {
                console.error("Camera Error:", err);
                cameraSpinner.classList.add('hidden');
                btnForceCamera.classList.remove('hidden');
                loadingText.innerHTML = `<span class="text-red-600 font-bold">Kamera gagal diakses.</span><br><span class="text-[10px]">Pastikan izin kamera diberikan.</span>`;
                lucide.createIcons();
            }
        }

        btnForceCamera.addEventListener('click', initCamera);

        function getLocation() {
            if (!navigator.geolocation) {
                gpsText.innerText = "GPS tidak didukung di browser ini.";
                return;
            }

            gpsDot.className = "w-2 h-2 bg-blue-500 rounded-full animate-ping";
            gpsText.innerText = "Mencari GPS...";
            document.getElementById('gps-error-guide').classList.add('hidden');

            const options = { 
                enableHighAccuracy: true, 
                timeout: 15000, 
                maximumAge: 0 
            };

            const success = (pos) => {
                userLocation = { lat: pos.coords.latitude, long: pos.coords.longitude };
                latVal.innerText = userLocation.lat.toFixed(6);
                longVal.innerText = userLocation.long.toFixed(6);
                
                gpsDot.className = "w-2 h-2 bg-green-500 rounded-full";
                gpsText.innerHTML = `GPS Aktif âœ“`;
                locationStatus.className = "text-sm text-green-700 font-bold flex items-center gap-2";
                
                locationDetails.classList.remove('hidden');
                document.getElementById('gps-error-guide').classList.add('hidden');
                validateForm();
            };

            const error = (err) => {
                console.warn(`ERROR(${err.code}): ${err.message}`);
                gpsDot.className = "w-2 h-2 bg-red-500 rounded-full";
                gpsText.innerText = "GPS bermasalah.";
                document.getElementById('gps-error-guide').classList.remove('hidden');
                lucide.createIcons();
            };

            // Hentikan watch sebelumnya jika ada
            if (watchId) navigator.geolocation.clearWatch(watchId);
            
            navigator.geolocation.getCurrentPosition(success, error, options);
            watchId = navigator.geolocation.watchPosition(success, error, options);
        }

        document.getElementById('btn-request-permission').addEventListener('click', getLocation);
        document.getElementById('btn-refresh-location').addEventListener('click', getLocation);

        btnCapture.addEventListener('click', () => {
            if (!stream) {
                alert("Kamera belum aktif.");
                return;
            }
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // Efek mirror untuk selfie
            ctx.translate(canvas.width, 0); 
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            capturedImage = canvas.toDataURL('image/jpeg', 0.5);
            preview.src = capturedImage;
            
            video.classList.add('hidden');
            preview.style.display = 'block';
            btnCapture.classList.add('hidden');
            btnRetake.classList.remove('hidden');
            validateForm();
        });

        btnRetake.addEventListener('click', () => {
            capturedImage = null;
            video.classList.remove('hidden');
            preview.style.display = 'none';
            btnCapture.classList.remove('hidden');
            btnRetake.classList.add('hidden');
            validateForm();
        });

        [studentNameInput, studentClassInput, studentNoInput].forEach(el => el.addEventListener('input', validateForm));

        function validateForm() {
            const isNameValid = studentNameInput.value.trim().length >= 3;
            const isClassValid = studentClassInput.value.trim() !== "";
            const isNoValid = studentNoInput.value.trim() !== "";
            btnSubmit.disabled = !(capturedImage && userLocation && isNameValid && isClassValid && isNoValid);
        }

        btnSubmit.addEventListener('click', async () => {
            if (btnSubmit.disabled) return;
            loadingOverlay.classList.remove('hidden');
            btnSubmit.disabled = true;

            const now = new Date();
            const mapsLink = `https://www.google.com/maps?q=${userLocation.lat},${userLocation.long}`;

            const formData = new URLSearchParams();
            formData.append('nama', studentNameInput.value.trim());
            formData.append('kelas', studentClassInput.value.trim());
            formData.append('no_absen', studentNoInput.value.trim());
            formData.append('tanggal', now.toLocaleDateString('id-ID'));
            formData.append('jam', now.toLocaleTimeString('id-ID'));
            formData.append('lat', userLocation.lat);
            formData.append('long', userLocation.long);
            formData.append('maps_link', mapsLink);

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    body: formData
                });
                
                loadingOverlay.classList.add('hidden');
                document.getElementById('modal-success').classList.remove('hidden');
            } catch (err) {
                loadingOverlay.classList.add('hidden');
                alert("Terjadi kesalahan saat mengirim data. Pastikan koneksi internet stabil.");
                btnSubmit.disabled = false;
            }
        });

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            studentNameInput.value = "";
            studentClassInput.value = "";
            studentNoInput.value = "";
            btnRetake.click();
        }
    </script>
</body>
</html>